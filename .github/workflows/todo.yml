name: ğŸ“ TODO Management

on:
  push:
    branches: ['main']
  schedule:
    # Weekly TODO scan every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

permissions:
  issues: write
  contents: read

jobs:
  scan-todos:
    name: ğŸ” Scan for TODOs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Scan for TODO comments
        id: todo-scan
        run: |
          echo "ğŸ” Scanning for TODO comments..."
          
          # Create output directory
          mkdir -p todo-reports
          
          # Scan for TODOs in source code
          {
            echo "# ğŸ“ TODO Items Found"
            echo ""
            echo "Generated on: $(date)"
            echo "Repository: ${{ github.repository }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo ""
            
            TODO_COUNT=0
            
            # Search for TODOs with context
            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                echo "- $line"
                ((TODO_COUNT++))
              fi
            done < <(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.md" \
              -E "(TODO|FIXME|HACK|XXX|BUG):" \
              ./apps ./services ./packages ./docs 2>/dev/null | head -50 || true)
            
            if [ $TODO_COUNT -eq 0 ]; then
              echo ""
              echo "ğŸ‰ No TODO items found!"
            else
              echo ""
              echo "ğŸ“Š Found $TODO_COUNT TODO item(s)"
              echo ""
              echo "## ğŸ’¡ Tips"
              echo "- Consider creating GitHub issues for important TODOs"
              echo "- Remove completed TODOs to keep the codebase clean"
              echo "- Use descriptive TODO comments with context"
            fi
            
            echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          } > todo-reports/todos.md
          
      - name: ğŸ“¤ Upload TODO report
        uses: actions/upload-artifact@v4
        with:
          name: todo-report-${{ github.run_number }}
          path: todo-reports/
          retention-days: 90
          
      - name: ğŸ“‹ Create/Update TODO Issue
        if: steps.todo-scan.outputs.todo_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const todoContent = fs.readFileSync('todo-reports/todos.md', 'utf8');
            const todoCount = '${{ steps.todo-scan.outputs.todo_count }}';
            
            const title = `ğŸ“ TODO Tracking - ${todoCount} items found`;
            const body = todoContent + `
            
            ---
            
            **Automated TODO Tracking**
            
            This issue is automatically updated when TODOs are found in the codebase.
            
            - ğŸ”„ Last updated: ${new Date().toISOString()}
            - ğŸ“Š Current count: ${todoCount} items
            - ğŸ¤– Generated by: TODO Management workflow`;
            
            // Look for existing TODO tracking issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'todo-tracking',
              state: 'open'
            });
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                title: title,
                body: body
              });
              console.log(`Updated existing TODO tracking issue #${issues[0].number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['todo-tracking', 'enhancement']
              });
              console.log(`Created new TODO tracking issue #${newIssue.number}`);
            }
            
      - name: ğŸ“Š TODO Summary
        run: |
          TODO_COUNT="${{ steps.todo-scan.outputs.todo_count }}"
          if [ "$TODO_COUNT" -eq 0 ]; then
            echo "ğŸ‰ No TODO items found - codebase is clean!"
          else
            echo "ğŸ“ Found $TODO_COUNT TODO item(s)"
            echo "ğŸ“‹ TODO tracking issue updated/created"
            echo "ğŸ“¤ Report uploaded as artifact"
          fi
